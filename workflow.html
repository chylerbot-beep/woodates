<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM Project Checklist</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --cream: #F5F0E8;
      --dark: #1A1A18;
      --warm-mid: #6B5B4E;
      --accent: #C4956A;
      --accent-light: #E8D5BF;
      --green-check: #4A7C59;
      --border: #D6CEC4;
      --phase-bg: #FDFBF8;
      --shadow: 0 2px 12px rgba(26, 26, 24, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      overflow-x: hidden;
    }

    body {
      background: var(--cream);
      font-family: 'DM Sans', sans-serif;
      color: var(--dark);
      min-height: 100vh;
      display: none;
      /* Hidden until session check */
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .app-header {
      background: var(--dark);
      color: var(--cream);
      padding: 28px 32px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .app-header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.5rem;
      letter-spacing: 0.01em;
      line-height: 1.1;
      overflow: visible;
    }

    .app-header h1 span {
      display: block;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }

    .save-status {
      font-size: 0.75rem;
      color: var(--accent);
      margin-right: 12px;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: #b37d50;
    }

    .btn-save {
      background: #fff;
      color: var(--dark);
      font-weight: 600;
    }

    .btn-save:hover {
      background: #e8e8e8;
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.1);
      color: var(--cream);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.18);
    }

    /* ‚îÄ‚îÄ PROJECT INFO CARD ‚îÄ‚îÄ */
    .project-card {
      margin: 20px 24px 12px;
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      border-left: 4px solid var(--accent);
    }

    .project-field label {
      display: block;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--warm-mid);
      margin-bottom: 4px;
    }

    .project-field input {
      width: 100%;
      border: none;
      border-bottom: 1.5px solid var(--border);
      padding: 6px 0;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: var(--dark);
      background: transparent;
      outline: none;
      transition: border-color 0.2s;
    }

    .project-field input:focus {
      border-color: var(--accent);
    }

    .project-field input::placeholder {
      color: #BDB5AD;
    }

    /* Hide native spin/calendar controls on date input */
    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="date"]::-webkit-clear-button {
      display: none;
      -webkit-appearance: none;
    }
    input[type="date"] {
      -moz-appearance: textfield;
    }

    /* ‚îÄ‚îÄ DESIGNERS PANEL ‚îÄ‚îÄ */
    .designers-card {
      margin: 0 24px 20px;
      background: white;
      border-radius: 12px;
      padding: 18px 24px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--accent);
    }

    .designers-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .designers-card-header label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--warm-mid);
    }

    .designers-add-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .designer-select-wrap {
      position: relative;
      flex: 1;
      min-width: 180px;
    }

    .designer-select {
      width: 100%;
      border: none;
      border-bottom: 1.5px solid var(--border);
      padding: 6px 28px 6px 0;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.88rem;
      color: var(--dark);
      background: transparent;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .designer-select:focus {
      border-color: var(--accent);
    }

    .designer-select-wrap::after {
      content: '‚ñæ';
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: var(--warm-mid);
      pointer-events: none;
    }

    .btn-add-designer {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .btn-add-designer:hover {
      background: #b37d50;
    }

    .btn-add-designer:disabled {
      background: var(--border);
      color: #9E9590;
      cursor: not-allowed;
    }

    .designer-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      min-height: 28px;
    }

    .designer-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-light);
      color: var(--dark);
      border-radius: 99px;
      padding: 4px 10px 4px 6px;
      font-size: 0.78rem;
      font-weight: 500;
    }

    .designer-tag.is-self {
      background: #DFF0D8;
    }

    .designer-tag .tag-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      font-size: 0.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      text-transform: uppercase;
    }

    .designer-tag.is-self .tag-avatar {
      background: var(--green-check);
    }

    .designer-tag .tag-name {
      line-height: 1.2;
    }

    .designer-tag .tag-you {
      font-size: 0.62rem;
      color: var(--green-check);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .designer-tag .tag-remove {
      cursor: pointer;
      color: var(--warm-mid);
      font-size: 1rem;
      line-height: 1;
      margin-left: 2px;
      transition: color 0.15s;
      display: flex;
      align-items: center;
    }

    .designer-tag .tag-remove:hover {
      color: #B85C5C;
    }

    body.readonly .designer-tag .tag-remove,
    body.readonly .designers-add-row {
      display: none;
    }

    .designers-empty {
      font-size: 0.75rem;
      color: #BDB5AD;
      font-style: italic;
    }

    /* ‚îÄ‚îÄ TASK META (timestamp + user) ‚îÄ‚îÄ */
    .task-timestamp {
      min-width: 110px;
      text-align: right;
      flex-shrink: 0;
      word-break: break-word;
    }

    .timestamp-who {
      display: block;
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
      margin-bottom: 1px;
    }

    /* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
    .progress-wrap {
      margin: 0 24px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .progress-label {
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--warm-mid);
      white-space: nowrap;
    }

    .progress-bar-bg {
      flex: 1;
      height: 5px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--green-check) 100%);
      border-radius: 99px;
      transition: width 0.4s ease;
      width: 0%;
    }

    .progress-pct {
      font-family: 'DM Serif Display', serif;
      font-size: 0.9rem;
      color: var(--warm-mid);
      min-width: 36px;
      text-align: right;
    }

    /* ‚îÄ‚îÄ PHASES ‚îÄ‚îÄ */
    .phases {
      padding: 0 24px 80px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .phase {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
    }

    .phase:hover {
      box-shadow: 0 4px 20px rgba(26, 26, 24, 0.12);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      background: var(--phase-bg);
      border-bottom: 1px solid var(--border);
    }

    .phase-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--dark);
      color: var(--cream);
      font-family: 'DM Serif Display', serif;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .phase.completed .phase-number {
      background: var(--green-check);
    }

    .phase-title-wrap {
      flex: 1;
      min-width: 0;
    }

    .phase-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1rem;
      color: var(--dark);
      line-height: 1.2;
    }

    .phase-objective {
      font-size: 0.75rem;
      color: var(--warm-mid);
      margin-top: 2px;
      font-style: italic;
    }

    .phase-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .phase-count {
      font-size: 0.72rem;
      color: var(--warm-mid);
      font-weight: 500;
      background: var(--accent-light);
      padding: 3px 9px;
      border-radius: 99px;
      white-space: nowrap;
    }

    .phase.completed .phase-count {
      background: #D4EDDA;
      color: var(--green-check);
    }

    .chevron {
      font-size: 0.7rem;
      color: var(--warm-mid);
      transition: transform 0.3s;
    }

    .phase.open .chevron {
      transform: rotate(180deg);
    }

    /* ‚îÄ‚îÄ TASK TABLE ‚îÄ‚îÄ */
    .phase-body {
      display: none;
    }

    .phase.open .phase-body {
      display: block;
    }

    .task-row {
      display: grid;
      grid-template-columns: 44px 1fr auto;
      align-items: start;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
      transition: background 0.15s;
    }

    .task-row:last-child {
      border-bottom: none;
    }

    .task-row:hover {
      background: #FDFAF6;
    }

    .task-row.checked {
      background: #F6FBF7;
    }

    .task-checkbox-wrap {
      display: flex;
      justify-content: center;
      padding-top: 2px;
    }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      background: white;
    }

    .task-checkbox:hover {
      border-color: var(--accent);
    }

    .task-row.checked .task-checkbox {
      background: var(--green-check);
      border-color: var(--green-check);
    }

    .task-checkbox::after {
      content: '';
      width: 5px;
      height: 9px;
      border: 2.5px solid white;
      border-top: none;
      border-left: none;
      transform: rotate(45deg) translateY(-1px);
      opacity: 0;
      transition: opacity 0.15s;
    }

    .task-row.checked .task-checkbox::after {
      opacity: 1;
    }

    .task-action {
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--dark);
      line-height: 1.35;
      margin-bottom: 4px;
    }

    .task-row.checked .task-action {
      text-decoration: line-through;
      color: #9E9590;
    }

    .task-notes {
      font-size: 0.77rem;
      color: var(--warm-mid);
      line-height: 1.5;
    }

    .timestamp-value {
      display: block;
      font-size: 0.68rem;
      color: var(--green-check);
      font-weight: 600;
      line-height: 1.3;
    }

    .timestamp-empty {
      display: block;
      font-size: 0.65rem;
      color: #C5BDB5;
      font-style: italic;
    }

    /* ‚îÄ‚îÄ SUB-TICK (Photo confirmation) ‚îÄ‚îÄ */
    .sub-tick-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 6px 10px;
      background: #F9F7F4;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .sub-checkbox {
      width: 16px;
      height: 16px;
      border: 1.5px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      background: white;
    }

    .sub-checkbox:hover {
      border-color: var(--accent);
    }

    .sub-checkbox.sub-checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .sub-checkbox.sub-checked::after {
      content: '';
      width: 4px;
      height: 7px;
      border: 2px solid white;
      border-top: none;
      border-left: none;
      transform: rotate(45deg) translateY(-1px);
      display: block;
    }

    .sub-tick-label {
      font-size: 0.75rem;
      color: var(--warm-mid);
      font-style: italic;
    }

    .sub-tick-row.sub-checked-row .sub-tick-label {
      text-decoration: line-through;
      color: #BDB5AD;
    }

    /* ‚îÄ‚îÄ PHASE NOTES ‚îÄ‚îÄ */
    .phase-notes-area {
      padding: 12px 20px 16px;
      background: #FDFBF8;
      border-top: 1px dashed var(--border);
    }

    .phase-notes-area label {
      display: block;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--warm-mid);
      margin-bottom: 6px;
    }

    .phase-notes-area textarea {
      width: 100%;
      min-height: 60px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      color: var(--dark);
      background: white;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    .phase-notes-area textarea:focus {
      border-color: var(--accent);
    }

    .phase-notes-area textarea::placeholder {
      color: #C5BDB5;
    }

    /* ‚îÄ‚îÄ EXPORT / RESET FOOTER ‚îÄ‚îÄ */
    .app-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 99;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.06);
    }

    .footer-info {
      font-size: 0.75rem;
      color: var(--warm-mid);
    }

    .footer-info strong {
      color: var(--dark);
      font-size: 0.85rem;
    }

    .footer-actions {
      display: flex;
      gap: 10px;
    }

    .btn-danger {
      background: transparent;
      color: #B85C5C;
      border: 1px solid #E0BEBE;
      font-size: 0.78rem;
    }

    .btn-danger:hover {
      background: #FDF0F0;
    }

    body.readonly .btn-ghost,
    body.readonly .btn-danger,
    body.readonly .btn-primary {
      display: none !important;
    }

    body.readonly input,
    body.readonly textarea,
    body.readonly .task-checkbox {
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ PDF PRINT ‚îÄ‚îÄ */
    @media print {

      .app-header,
      .app-footer,
      .progress-wrap {
        display: none !important;
      }

      .phase {
        break-inside: avoid;
        box-shadow: none !important;
      }

      .phase-body {
        display: block !important;
      }

      body {
        background: white;
      }

      .phases {
        padding: 0 0 20px;
      }

      .project-card {
        margin: 10px 0;
        box-shadow: none;
      }
    }

    @media (max-width: 768px) {
      .app-header {
        padding: 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .app-header h1 {
        font-size: 1.2rem;
      }

      .header-actions {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .save-status {
        margin-right: 0;
        margin-bottom: 4px;
        text-align: left;
      }

      .header-actions .btn-group {
        display: flex;
        gap: 8px;
        width: 100%;
      }

      .btn {
        flex: 1;
        justify-content: center;
        padding: 10px 8px;
        font-size: 0.75rem;
      }

      .project-card {
        margin: 12px;
        padding: 16px;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .designers-card {
        margin: 0 12px 0;
        padding: 14px 16px;
      }

      .progress-wrap {
        margin: 0 12px 12px;
      }

      .phases {
        padding: 0 12px 80px;
        gap: 12px;
      }

      .phase-header {
        padding: 12px 14px;
      }

      .task-row {
        padding: 10px 14px;
        grid-template-columns: 32px 1fr auto;
        gap: 10px;
      }

      /* Timestamp col: shrink on mobile, allow wrapping */
      .task-timestamp {
        min-width: 70px;
        max-width: 90px;
      }

      .timestamp-who {
        font-size: 0.65rem;
      }

      .timestamp-value {
        font-size: 0.62rem;
      }

      /* Header: wrap buttons into 2 rows on very small screens */
      .header-actions .btn-group {
        flex-wrap: wrap;
      }

      .btn {
        min-width: 60px;
      }

      /* Designer select: stack vertically */
      .designers-add-row {
        flex-direction: column;
        align-items: stretch;
      }

      .designer-select-wrap {
        width: 100%;
      }

      .btn-add-designer {
        width: 100%;
        text-align: center;
      }

      /* Sub-tick: ensure it fits on narrow screens */
      .sub-tick-row {
        flex-wrap: wrap;
      }

      .sub-tick-label {
        font-size: 0.7rem;
      }
    }
  </style>
</head>

<body>

  <header class="app-header">
    <div>
      <h1>
        <span>Woodates Design &amp; Build</span>
        PM Project Checklist
      </h1>
    </div>
    <div class="header-actions">
      <span class="save-status" id="saveStatus"></span>
      <div class="btn-group">
        <button class="btn btn-ghost" onclick="window.location.href='index.html'"
          style="border-color: rgba(255,255,255,0.2); color: #BDB5AD;">‚Üê Home</button>
        <button class="btn btn-save" id="saveBtn" onclick="manualSave()">üíæ Save</button>
        <button class="btn btn-ghost" onclick="resetAll()">‚Ü∫ Reset</button>
      </div>
    </div>
  </header>

  <div class="project-card" id="projectCard">
    <div class="project-field">
      <label>Project Name</label>
      <input type="text" id="proj_name" placeholder="e.g. 3-Room BTO ‚Äì Tampines St 11" />
    </div>
    <div class="project-field">
      <label>Client Name</label>
      <input type="text" id="proj_client" placeholder="Client name" />
    </div>
    <div class="project-field">
      <label>Date of Signing</label>
      <input type="date" id="proj_date" />
    </div>
  </div>

  <div class="designers-card" id="designersCard">
    <div class="designers-card-header">
      <label>Assigned Designers</label>
    </div>
    <div class="designers-add-row" id="designerAddRow">
      <div class="designer-select-wrap">
        <select class="designer-select" id="designerSelect">
          <option value="">‚Äî Select a designer to add ‚Äî</option>
        </select>
      </div>
      <button class="btn-add-designer" id="btnAddDesigner" onclick="addDesignerFromSelect()" disabled>+ Add</button>
    </div>
    <div class="designer-tags" id="designerTags">
      <span class="designers-empty" id="designersEmpty">No designers assigned yet.</span>
    </div>
  </div>

  <div class="progress-wrap">
    <span class="progress-label">Overall Progress</span>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <span class="progress-pct" id="progressPct">0%</span>
  </div>

  <div class="phases" id="phasesContainer"></div>

  <footer class="app-footer">
    <div class="footer-info">
      <strong id="footerChecked">0</strong> / <span id="footerTotal">0</span> tasks completed
    </div>
    <div class="footer-actions">
      <button class="btn btn-danger" onclick="resetAll()">Reset All</button>
    </div>
  </footer>

  <script>
    const { createClient } = supabase;
    const _supabase = createClient(
      'https://ilytehukqrkwpupdpkgo.supabase.co',
      'sb_publishable_tNMpLdZaqm0e-El_LP4kKg_fhfj-ARF'
    );

    const PHASES = [
      {
        num: 1,
        title: "Onboarding & Setup",
        sub: "Week 1",
        objective: 'Establish communication and manage "The Waiting Period."',
        tasks: [
          { action: "Create Project Group Chat", notes: "Include: ID, Project Manager, Admin (Booking), 3D Designer, & Owners." },
          { action: "Upload Project Files", notes: "Upload Original Layout, Furniture Plan, and Signed Quotation to chat." },
          { action: "Request Mood Board", notes: "Ask owner for reference photos for 3D rendering." },
          { action: "Conduct Onboarding Brief", notes: 'Explain timeline (2 weeks for 3D). Manage expectations on "waiting time."' },
          { action: "Book Material Selections", notes: "Task Admin to book: Vinyl, Tiles, Laminate, Sintered Stone, Glass." }
        ]
      },
      {
        num: 2,
        title: "Design & Owner Purchasing",
        sub: null,
        objective: "Finalize visuals and ensure owner buys critical built-in items.",
        tasks: [
          { action: "3D Rendering", notes: "Send renders to owner (approx. 2 weeks post-signing). Note: If 3D colors are totally wrong, re-render. If slight shade difference, explain to owner." },
          { action: "Owner Shopping List (Priority 1)", notes: "Ensure owner selects: Lights, Fans, Kitchen Appliances (Hob/Hood/Oven), Fridge dimensions." },
          { action: "Owner Shopping List (Priority 2)", notes: "Bathroom Accessories. (Loose furniture like sofas can wait)." }
        ]
      },
      {
        num: 3,
        title: "The First Site Visit",
        sub: "Key Collection",
        objective: "The critical technical run-through. Must be done with Aircon Contractor.",
        tasks: [
          { action: "Aircon Trunking Check", notes: "Decision: Trunking vs. L-Box? Price: Contractor to quote box-up price on the spot.", photoSent: true },
          { action: "Carpentry Placement", notes: "Action: Tape furniture layout on floor for owner visualization.", photoSent: true },
          { action: "Initial Site Measurement", notes: "Carpenter or ID to take fabrication measurements.", photoSent: true },
          { action: "Electrical Walkthrough", notes: "Confirm positions for: Switches, Sockets, Data points, Ceiling lighting points.", photoSent: true },
          { action: "Review: Shower Area", notes: "Confirm Shower Screen position & Kerb position.", photoSent: true },
          { action: "Review: Wet Works", notes: "Cement Base: Fridge/Washing Machine base needed? Entrance: Slope or Drop? (For tiling/vinyl).", photoSent: true },
          { action: "Review: False Ceiling", notes: "Confirm height, curtain pelmet gap size, and cove light distance.", photoSent: true },
          { action: "Review: Hacking", notes: "(If applicable) Mark exactly which wall and extent of hacking.", photoSent: true },
          { action: "Same-Day Summary", notes: "Post Site Visit: Send a text summary of all discussed points and TBC items to Group Chat on the same day." }
        ]
      },
      {
        num: 4,
        title: "Commencement & Pre-Work",
        sub: null,
        objective: 'Finalize costs, collect payment, and prepare for "Dirty Work."',
        tasks: [
          { action: "Finalize Electrical Plan", notes: "Update Electrical/Lighting plan based on site visit. Zoom call to confirm." },
          { action: "Generate Electrical VO", notes: "Create Quotation/VO for Electrical work + any site visit add-ons (e.g., Aircon box-up)." },
          { action: "Billing", notes: "Issue Invoice: 35% Progress Payment + Electrical VO." },
          { action: "Collect Payment", notes: "CRITICAL: Do not start work until payment is received." },
          { action: "Start Work Schedule", notes: 'Confirm start date. Put date in "Set More" (booking system) early so Boss can arrange workers.' }
        ]
      },
      {
        num: 5,
        title: "Execution ‚Äì Wet Works & Ceiling",
        sub: null,
        objective: "Structural works and forward planning.",
        tasks: [
          { action: "Day 1: Hacking & Electrical Briefing", notes: "ID must go down. Brief workers on what to hack. Confirm positions with Owner." },
          { action: "Site Protection", notes: "Priority 1: Instruct workers to protect house/flooring before any work starts." },
          { action: "Forward Planning (Critical)", notes: "Do not wait for electrical to finish to plan next step.\n1. Book False Ceiling Guy.\n2. Book Tiler (Note: Tiler does not haul tiles; book in-house labor for haulage).\n3. Order and Deliver Tiles." },
          { action: "Electrical Inspection", notes: "Confirm all wiring/points correct before False Ceiling guy comes in." },
          { action: "False Ceiling Inspection", notes: "ID must check false ceiling work (leveling/structure) before Tiler comes in." }
        ]
      },
      {
        num: 6,
        title: 'Carpentry Prep',
        sub: 'The "Fabrication Gap" ‚Äì approx. 2‚Äì3 weeks',
        objective: "Detailed planning while carpentry is being made.",
        tasks: [
          { action: "Re-Measure Site", notes: "Once tiling/ceiling is done, heights change. Do site measurement again for accuracy." },
          { action: "Carpentry Drawings", notes: "Send measurements to drafter (Nancy). Produce drawings (3‚Äì5 days). Send to Owner." },
          { action: "On-Site Carpentry Discussion", notes: "Meet owner on-site.\nMust Confirm:\n1. Depth of carpentry.\n2. Exact switch/socket positions inside carpentry (Left/Right/Top/Bottom)." },
          { action: "Laminate Confirmation", notes: "Confirm Laminate codes using 3D renders as a guide." },
          { action: "Fabrication Handover", notes: "Pass confirmed drawings to Carpenter (Daniel/Boss/Self) to start fabrication." },
          { action: "Mid-Reno Coordination", notes: "While waiting for carpentry (2‚Äì3 weeks):\n1. Suppliers measure Windows/Shower Screens.\n2. Painter: Sealer & Matex (1st Coat).\n3. Plumber: Run pipings, install storage heater.\n4. Electrician." },
          { action: "Owner Delivery Reminder", notes: "Remind owner to deliver Hob/Hood/Oven/Sinks now so they are ready for carpentry installation." }
        ]
      },
      {
        num: 7,
        title: "Carpentry Installation",
        sub: null,
        objective: "Installation and supervision.",
        tasks: [
          { action: "Installation Day 1", notes: 'ID must be present. Act as "Kepala" (Supervisor) to direct placement and workflow.' },
          { action: "Routine Checks", notes: "Visit site every 2‚Äì3 days during installation to catch issues early." },
          { action: "Electrical 2nd Fix", notes: "Once carpentry is up, Electrician returns to install switches/sockets onto the carpentry." }
        ]
      },
      {
        num: 8,
        title: "Countertops & Finishing",
        sub: null,
        objective: "The final push.",
        tasks: [
          { action: "Table Top Measurement", notes: "Arrange stone supplier to measure. Confirm Stone color with owner." },
          { action: "Touch-Up & Painting", notes: "While waiting for stone:\n1. Touch-up Man (Joint lines/carpentry).\n2. Painter (Final Coat)." },
          { action: "Plumbing Finals", notes: "After stone installed: Plumber installs Sink, Tap, Bathroom Accessories, Dishwasher/Washing machine." }
        ]
      },
      {
        num: 9,
        title: "Handover",
        sub: null,
        objective: "Client Inspection and completion.",
        tasks: [
          { action: "Owner Walkthrough", notes: "Invite owner to site. Walk around to identify any final touch-ups needed." },
          { action: "Final Rectification", notes: "Execute touch-ups based on walkthrough." },
          { action: "General Cleaning", notes: "Perform one last round of general cleaning." },
          { action: "Handover", notes: "Official handover of keys and project completion." }
        ]
      }
    ];

    // State
    let state = {};
    let projectId = new URLSearchParams(window.location.search).get('project_id');
    let isReadonly = new URLSearchParams(window.location.search).get('readonly') === 'true';
    let currentUser = null;
    let currentUserIsAdmin = false;
    let currentUserName = '';
    let currentUserId = '';
    let designers = []; // array of {id, name} objects
    let allDesignerProfiles = []; // all profiles with role=designer fetched from DB

    function getKey(pIdx, tIdx) { return `p${pIdx}_t${tIdx}`; }
    function getNoteKey(pIdx) { return `note_p${pIdx}`; }

    async function logout() {
      await _supabase.auth.signOut();
      window.location.href = 'index.html';
    }

    async function init() {
      const { data: { session } } = await _supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = session.user;
      document.body.style.display = 'block';
      if (isReadonly) document.body.classList.add('readonly');

      if (projectId) {
        await loadProjectData();
      } else {
        showToast('No project ID found');
        window.location.href = 'index.html';
      }
    }

    async function loadProjectData() {
      const { data: project, error } = await _supabase
        .from('projects')
        .select('*')
        .eq('id', projectId)
        .single();

      if (!project || error) {
        showToast('Project not found.');
        window.location.href = 'index.html';
        return;
      }

      // Ownership check: fetch current user's profile to check role/name
      const { data: profile } = await _supabase
        .from('profiles')
        .select('role, full_name')
        .eq('id', currentUser.id)
        .single();

      const isAdmin = profile && profile.role === 'admin';
      currentUserIsAdmin = isAdmin;
      currentUserName = profile ? (profile.full_name || currentUser.email) : currentUser.email;
      currentUserId   = currentUser.id;
      const isOwner = project.user_id === currentUser.id;

      if (!isOwner && !isAdmin) {
        showToast('You do not have permission to view this project');
        window.location.href = 'index.html';
        return;
      }

      state = project.phase_data || {};
      // Migrate: if designers are plain strings, convert to objects
      const rawDesigners = project.designers || [];
      designers = rawDesigners.map(d =>
        typeof d === 'string' ? { id: d, name: d } : d
      );

      // Auto-add current user if not already in the list
      if (!isReadonly && !designers.find(d => d.id === currentUser.id)) {
        designers.unshift({ id: currentUser.id, name: currentUserName });
      }

      // Fetch all users with designer or admin role for the dropdown
      await loadDesignerProfiles();

      document.getElementById('proj_name').value = project.project_name || '';
      document.getElementById('proj_client').value = project.client_name || '';
      document.getElementById('proj_date').value = project.date_of_signing || '';
      renderDesigners();
      buildUI();
    }

    function triggerSave() {
      if (isReadonly) return;
      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = 'Unsaved changes‚Ä¶';
      statusEl.style.color = '#BDB5AD';
    }

    async function manualSave() {
      if (isReadonly) return;
      await saveProjectData();
    }

    async function saveProjectData() {
      const pName = document.getElementById('proj_name').value;
      const cName = document.getElementById('proj_client').value;
      const dSign = document.getElementById('proj_date').value;

      // Check if completed
      let totalTasks = PHASES.reduce((acc, p) => acc + p.tasks.length, 0);
      let checkedTasks = 0;
      PHASES.forEach((p, pIdx) => {
        p.tasks.forEach((_, tIdx) => {
          if (state[getKey(pIdx, tIdx)]) checkedTasks++;
        });
      });
      const status = checkedTasks === totalTasks ? 'completed' : 'in_progress';

      let query = _supabase
        .from('projects')
        .update({
          project_name: pName,
          client_name: cName,
          date_of_signing: dSign,
          phase_data: state,
          designers: designers,
          status: status,
          updated_at: new Date().toISOString()
        })
        .eq('id', projectId);

      // For non-admin users, add user_id filter to satisfy RLS policy
      if (!currentUserIsAdmin) {
        query = query.eq('user_id', currentUser.id);
      }

      const { error } = await query;

      const statusEl = document.getElementById('saveStatus');
      if (error) {
        console.error('Save error:', error.message, error.details, error.hint);
        statusEl.textContent = 'Save failed ‚úó';
        statusEl.style.color = '#B85C5C';
      } else {
        statusEl.textContent = 'Saved ‚úì';
        statusEl.style.color = '#C4956A';
      }
    }

    function updateProgress() {
      let total = 0, done = 0;
      PHASES.forEach((phase, pIdx) => {
        phase.tasks.forEach((_, tIdx) => {
          total++;
          if (state[getKey(pIdx, tIdx)]) done++;
        });
      });

      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressPct').textContent = pct + '%';
      document.getElementById('footerChecked').textContent = done;
      document.getElementById('footerTotal').textContent = total;

      PHASES.forEach((phase, pIdx) => {
        const el = document.getElementById(`phase_${pIdx}`);
        if (!el) return;
        const allDone = phase.tasks.every((_, tIdx) => state[getKey(pIdx, tIdx)]);
        el.classList.toggle('completed', allDone);
        const cnt = phase.tasks.filter((_, tIdx) => state[getKey(pIdx, tIdx)]).length;
        const countEl = el.querySelector('.phase-count');
        if (countEl) countEl.textContent = `${cnt} / ${phase.tasks.length}`;
      });
    }

    function formatTimestamp() {
      const now = new Date();
      const date = now.toLocaleDateString('en-SG', { day: '2-digit', month: 'short', year: 'numeric' });
      const time = now.toLocaleTimeString('en-SG', { hour: '2-digit', minute: '2-digit', hour12: true });
      return date + ' / ' + time;
    }

    function renderTickMeta(tsVal, whoVal) {
      if (!tsVal) return '<span class="timestamp-empty">‚Äî</span>';
      const who = whoVal ? `<span class="timestamp-who">${whoVal}</span>` : '';
      return `${who}<span class="timestamp-value">${tsVal}</span>`;
    }

    function toggleTask(pIdx, tIdx) {
      if (isReadonly) return;
      const key = getKey(pIdx, tIdx);
      state[key] = !state[key];

      const signKey = `sign_p${pIdx}_t${tIdx}`;
      const whoKey  = `who_p${pIdx}_t${tIdx}`;

      if (state[key]) {
        state[signKey] = formatTimestamp();
        state[whoKey]  = currentUserName;
      } else {
        delete state[signKey];
        delete state[whoKey];
      }

      const row = document.getElementById(`row_${pIdx}_${tIdx}`);
      row.classList.toggle('checked', state[key]);

      const tsEl = row.querySelector('.task-timestamp');
      if (tsEl) {
        tsEl.innerHTML = renderTickMeta(state[signKey], state[whoKey]);
      }

      updateProgress();
      triggerSave();
    }

    function getSubKey(pIdx, tIdx) { return `sub_p${pIdx}_t${tIdx}`; }

    function toggleSubTick(pIdx, tIdx) {
      if (isReadonly) return;
      const key = getSubKey(pIdx, tIdx);
      state[key] = !state[key];

      const subRow = document.getElementById(`subrow_${pIdx}_${tIdx}`);
      const subBox = document.getElementById(`subcb_${pIdx}_${tIdx}`);
      if (subRow) subRow.classList.toggle('sub-checked-row', state[key]);
      if (subBox) subBox.classList.toggle('sub-checked', state[key]);

      triggerSave();
    }

    function togglePhase(pIdx) {
      const el = document.getElementById(`phase_${pIdx}`);
      el.classList.toggle('open');
    }

    function saveNote(pIdx, val) {
      state[getNoteKey(pIdx)] = val;
      triggerSave();
    }

    function buildUI() {
      const container = document.getElementById('phasesContainer');
      container.innerHTML = '';

      PHASES.forEach((phase, pIdx) => {
        const el = document.createElement('div');
        el.className = 'phase';
        el.id = `phase_${pIdx}`;

        // Auto-open first incomplete phase or if all complete open first
        const allDone = phase.tasks.every((_, tIdx) => state[getKey(pIdx, tIdx)]);
        if (!allDone && pIdx === 0) el.classList.add('open');

        const cnt = phase.tasks.filter((_, tIdx) => state[getKey(pIdx, tIdx)]).length;

        el.innerHTML = `
      <div class="phase-header" onclick="togglePhase(${pIdx})">
        <div class="phase-number">${phase.num}</div>
        <div class="phase-title-wrap">
          <div class="phase-title">${phase.title}${phase.sub ? ` <small style="font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:400;color:var(--warm-mid);">&mdash; ${phase.sub}</small>` : ''}</div>
          <div class="phase-objective">${phase.objective}</div>
        </div>
        <div class="phase-meta">
          <span class="phase-count">${cnt} / ${phase.tasks.length}</span>
          <span class="chevron">‚ñº</span>
        </div>
      </div>
      <div class="phase-body" id="phasebody_${pIdx}">
        ${phase.tasks.map((task, tIdx) => {
          const checked = state[getKey(pIdx, tIdx)] ? 'checked' : '';
          const tsVal  = state[`sign_p${pIdx}_t${tIdx}`] || '';
          const whoVal = state[`who_p${pIdx}_t${tIdx}`]  || '';
          const subChecked = task.photoSent ? !!state[`sub_p${pIdx}_t${tIdx}`] : false;
          const subTick = task.photoSent ? `
            <div class="sub-tick-row${subChecked ? ' sub-checked-row' : ''}" id="subrow_${pIdx}_${tIdx}">
              <div class="sub-checkbox${subChecked ? ' sub-checked' : ''}" id="subcb_${pIdx}_${tIdx}"
                onclick="event.stopPropagation(); toggleSubTick(${pIdx}, ${tIdx})"></div>
              <span class="sub-tick-label">üì∏ Photo sent to WhatsApp group</span>
            </div>` : '';
          return `
          <div class="task-row ${checked}" id="row_${pIdx}_${tIdx}">
            <div class="task-checkbox-wrap">
              <div class="task-checkbox" onclick="toggleTask(${pIdx}, ${tIdx})"></div>
            </div>
            <div class="task-content">
              <div class="task-action">${task.action}</div>
              <div class="task-notes">${task.notes.replace(/\n/g, '<br>')}</div>
              ${subTick}
            </div>
            <div class="task-timestamp" onclick="event.stopPropagation()">
              ${renderTickMeta(tsVal, whoVal)}
            </div>
          </div>`;
        }).join('')}
        <div class="phase-notes-area">
          <label>Phase Notes</label>
          <textarea placeholder="Add site notes, decisions, or follow-ups for this phase‚Ä¶" 
            onclick="event.stopPropagation()"
            oninput="saveNote(${pIdx}, this.value)">${state[getNoteKey(pIdx)] || ''}</textarea>
        </div>
      </div>
    `;

        if (allDone) el.classList.add('completed');
        container.appendChild(el);
      });

      updateProgress();
    }


    // ‚îÄ‚îÄ DESIGNER MANAGEMENT ‚îÄ‚îÄ
    function getInitials(name) {
      return (name || '?').trim().split(/\s+/).map(w => w[0]).join('').substring(0, 2).toUpperCase();
    }

    async function loadDesignerProfiles() {
      // Fetch all profiles with role 'designer' or 'admin'
      const { data, error } = await _supabase
        .from('profiles')
        .select('id, full_name')
        .in('role', ['designer', 'admin'])
        .order('full_name');

      if (!error && data) {
        allDesignerProfiles = data;
      }
      populateDesignerDropdown();
    }

    function populateDesignerDropdown() {
      const sel = document.getElementById('designerSelect');
      if (!sel) return;
      // Clear existing options except placeholder
      sel.innerHTML = '<option value="">‚Äî Select a designer to add ‚Äî</option>';

      const assignedIds = designers.map(d => d.id);
      allDesignerProfiles.forEach(p => {
        // Skip already-assigned designers
        if (assignedIds.includes(p.id)) return;
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.full_name || p.id;
        sel.appendChild(opt);
      });

      // Enable/disable Add button based on selection
      sel.onchange = () => {
        document.getElementById('btnAddDesigner').disabled = !sel.value;
      };
    }

    function renderDesigners() {
      const container = document.getElementById('designerTags');
      const emptyEl   = document.getElementById('designersEmpty');
      if (!container) return;

      Array.from(container.querySelectorAll('.designer-tag')).forEach(el => el.remove());

      if (designers.length === 0) {
        if (emptyEl) emptyEl.style.display = '';
      } else {
        if (emptyEl) emptyEl.style.display = 'none';
        designers.forEach((d, idx) => {
          const isSelf = d.id === currentUserId;
          const tag = document.createElement('span');
          tag.className = 'designer-tag' + (isSelf ? ' is-self' : '');
          tag.innerHTML = `
            <span class="tag-avatar">${getInitials(d.name)}</span>
            <span class="tag-name">
              ${d.name}
              ${isSelf ? '<span class="tag-you">You</span>' : ''}
            </span>
            ${!isReadonly ? `<span class="tag-remove" onclick="removeDesigner(${idx})" title="Remove">√ó</span>` : ''}
          `;
          container.appendChild(tag);
        });
      }

      // Refresh dropdown to exclude newly-added names
      populateDesignerDropdown();
    }

    function addDesignerFromSelect() {
      if (isReadonly) return;
      const sel = document.getElementById('designerSelect');
      const id  = sel.value;
      if (!id) return;
      const profile = allDesignerProfiles.find(p => p.id === id);
      if (!profile) return;
      if (designers.find(d => d.id === id)) return;
      designers.push({ id: profile.id, name: profile.full_name || profile.id });
      sel.value = '';
      document.getElementById('btnAddDesigner').disabled = true;
      renderDesigners();
      triggerSave();
    }

    function removeDesigner(idx) {
      if (isReadonly) return;
      designers.splice(idx, 1);
      renderDesigners();
      triggerSave();
    }

    function resetAll() {
      if (isReadonly) return;
      if (!confirm('Reset all checkboxes and notes? Project name and client info will be kept.')) return;
      state = {};
      buildUI();
      triggerSave();
    }

    // Event Listeners
    document.getElementById('proj_name').addEventListener('input', triggerSave);
    document.getElementById('proj_client').addEventListener('input', triggerSave);
    document.getElementById('proj_date').addEventListener('change', triggerSave);

    init();
  </script>
<script>

// ‚îÄ‚îÄ Toast notification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type='error') {
  let t = document.getElementById('_app_toast');
  if(!t) {
    t = document.createElement('div');
    t.id = '_app_toast';
    t.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);z-index:99999;padding:12px 24px;border-radius:8px;font-family:DM Sans,sans-serif;font-size:0.85rem;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.15);transition:opacity 0.4s;pointer-events:none';
    document.body.appendChild(t);
  }
  const cols = {error:['#FEE2E2','#991B1B'], success:['#D1FAE5','#065F46'], info:['#EBF3FB','#1D4ED8']};
  const [bg, color] = cols[type]||cols.error;
  t.style.background=bg; t.style.color=color;
  t.textContent=msg; t.style.opacity='1';
  clearTimeout(t._hide); t._hide=setTimeout(()=>{ t.style.opacity='0'; },4000);
}

</script>
</body>

</html>
