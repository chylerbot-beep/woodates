<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID Project Workflow</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --cream: #F5F0E8;
      --dark: #1A1A18;
      --warm-mid: #6B5B4E;
      --accent: #C4956A;
      --accent-light: #E8D5BF;
      --green-check: #4A7C59;
      --border: #D6CEC4;
      --phase-bg: #FDFBF8;
      --shadow: 0 2px 12px rgba(26, 26, 24, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    html {
      overflow-x: hidden;
    }

    body {
      background: var(--cream);
      font-family: 'DM Sans', sans-serif;
      color: var(--dark);
      min-height: 100vh;
      display: none;
      /* Hidden until session check */
    }

    /* â”€â”€ HEADER â”€â”€ */
    .app-header {
      background: var(--dark);
      color: var(--cream);
      padding: 28px 32px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .app-header h1 {
      font-family: 'DM Serif Display', serif;
      font-size: 1.5rem;
      letter-spacing: 0.01em;
      line-height: 1.1;
    }

    .app-header h1 span {
      display: block;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.7rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-shrink: 0;
    }

    .save-status {
      font-size: 0.75rem;
      color: var(--accent);
      margin-right: 12px;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: #b37d50;
    }

    .btn-save {
      background: #fff;
      color: var(--dark);
      font-weight: 600;
    }

    .btn-save:hover {
      background: #e8e8e8;
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.1);
      color: var(--cream);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.18);
    }

    /* â”€â”€ PROJECT INFO CARD â”€â”€ */
    .project-card {
      margin: 20px 24px;
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      border-left: 4px solid var(--accent);
    }

    .project-field label {
      display: block;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--warm-mid);
      margin-bottom: 4px;
    }

    .project-field input {
      width: 100%;
      border: none;
      border-bottom: 1.5px solid var(--border);
      padding: 6px 0;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      color: var(--dark);
      background: transparent;
      outline: none;
      transition: border-color 0.2s;
    }

    .project-field input:focus {
      border-color: var(--accent);
    }

    .project-field input::placeholder {
      color: #BDB5AD;
    }

    /* â”€â”€ PROGRESS BAR â”€â”€ */
    .progress-wrap {
      margin: 0 24px 8px;
      background: white;
      border-radius: 10px;
      padding: 14px 20px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .progress-label {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--warm-mid);
      white-space: nowrap;
    }

    .progress-bar-bg {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent) 0%, var(--green-check) 100%);
      border-radius: 99px;
      transition: width 0.4s ease;
      width: 0%;
    }

    .progress-pct {
      font-family: 'DM Serif Display', serif;
      font-size: 1.1rem;
      color: var(--dark);
      min-width: 42px;
      text-align: right;
    }

    /* â”€â”€ PHASES â”€â”€ */
    .phases {
      padding: 0 24px 80px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .phase {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
    }

    .phase:hover {
      box-shadow: 0 4px 20px rgba(26, 26, 24, 0.12);
    }

    .phase-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      background: var(--phase-bg);
      border-bottom: 1px solid var(--border);
    }

    .phase-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--dark);
      color: var(--cream);
      font-family: 'DM Serif Display', serif;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .phase.completed .phase-number {
      background: var(--green-check);
    }

    .phase-title-wrap {
      flex: 1;
      min-width: 0;
    }

    .phase-title {
      font-family: 'DM Serif Display', serif;
      font-size: 1rem;
      color: var(--dark);
      line-height: 1.2;
    }

    .phase-objective {
      font-size: 0.75rem;
      color: var(--warm-mid);
      margin-top: 2px;
      font-style: italic;
    }

    .phase-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .phase-count {
      font-size: 0.72rem;
      color: var(--warm-mid);
      font-weight: 500;
      background: var(--accent-light);
      padding: 3px 9px;
      border-radius: 99px;
      white-space: nowrap;
    }

    .phase.completed .phase-count {
      background: #D4EDDA;
      color: var(--green-check);
    }

    .chevron {
      font-size: 0.7rem;
      color: var(--warm-mid);
      transition: transform 0.3s;
    }

    .phase.open .chevron {
      transform: rotate(180deg);
    }

    /* â”€â”€ TASK TABLE â”€â”€ */
    .phase-body {
      display: none;
    }

    .phase.open .phase-body {
      display: block;
    }

    .task-row {
      display: grid;
      grid-template-columns: 44px 1fr auto;
      align-items: start;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
      transition: background 0.15s;
    }

    .task-row:last-child {
      border-bottom: none;
    }

    .task-row:hover {
      background: #FDFAF6;
    }

    .task-row.checked {
      background: #F6FBF7;
    }

    .task-checkbox-wrap {
      display: flex;
      justify-content: center;
      padding-top: 2px;
    }

    .task-checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
      background: white;
    }

    .task-checkbox:hover {
      border-color: var(--accent);
    }

    .task-row.checked .task-checkbox {
      background: var(--green-check);
      border-color: var(--green-check);
    }

    .task-checkbox::after {
      content: '';
      width: 5px;
      height: 9px;
      border: 2.5px solid white;
      border-top: none;
      border-left: none;
      transform: rotate(45deg) translateY(-1px);
      opacity: 0;
      transition: opacity 0.15s;
    }

    .task-row.checked .task-checkbox::after {
      opacity: 1;
    }

    .task-action {
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--dark);
      line-height: 1.35;
      margin-bottom: 4px;
    }

    .task-row.checked .task-action {
      text-decoration: line-through;
      color: #9E9590;
    }

    .task-notes {
      font-size: 0.77rem;
      color: var(--warm-mid);
      line-height: 1.5;
    }

    .task-timestamp {
      min-width: 90px;
      text-align: right;
      flex-shrink: 0;
    }

    .timestamp-value {
      display: block;
      font-size: 0.68rem;
      color: var(--green-check);
      font-weight: 600;
      line-height: 1.3;
      white-space: nowrap;
    }

    .timestamp-empty {
      display: block;
      font-size: 0.65rem;
      color: #C5BDB5;
      font-style: italic;
    }

    /* â”€â”€ PHASE NOTES â”€â”€ */
    .phase-notes-area {
      padding: 12px 20px 16px;
      background: #FDFBF8;
      border-top: 1px dashed var(--border);
    }

    .phase-notes-area label {
      display: block;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--warm-mid);
      margin-bottom: 6px;
    }

    .phase-notes-area textarea {
      width: 100%;
      min-height: 60px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.8rem;
      color: var(--dark);
      background: white;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }

    .phase-notes-area textarea:focus {
      border-color: var(--accent);
    }

    .phase-notes-area textarea::placeholder {
      color: #C5BDB5;
    }

    /* â”€â”€ EXPORT / RESET FOOTER â”€â”€ */
    .app-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 99;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.06);
    }

    .footer-info {
      font-size: 0.75rem;
      color: var(--warm-mid);
    }

    .footer-info strong {
      color: var(--dark);
      font-size: 0.85rem;
    }

    .footer-actions {
      display: flex;
      gap: 10px;
    }

    .btn-danger {
      background: transparent;
      color: #B85C5C;
      border: 1px solid #E0BEBE;
      font-size: 0.78rem;
    }

    .btn-danger:hover {
      background: #FDF0F0;
    }

    body.readonly .btn-ghost,
    body.readonly .btn-danger,
    body.readonly .btn-primary {
      display: none !important;
    }

    body.readonly input,
    body.readonly textarea,
    body.readonly .task-checkbox {
      pointer-events: none;
    }

    /* â”€â”€ PDF PRINT â”€â”€ */
    @media print {

      .app-header,
      .app-footer,
      .progress-wrap {
        display: none !important;
      }

      .phase {
        break-inside: avoid;
        box-shadow: none !important;
      }

      .phase-body {
        display: block !important;
      }

      body {
        background: white;
      }

      .phases {
        padding: 0 0 20px;
      }

      .project-card {
        margin: 10px 0;
        box-shadow: none;
      }
    }

    @media (max-width: 768px) {
      .app-header {
        padding: 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .app-header h1 {
        font-size: 1.2rem;
      }

      .header-actions {
        width: 100%;
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .save-status {
        margin-right: 0;
        margin-bottom: 4px;
        text-align: left;
      }

      .header-actions .btn-group {
        display: flex;
        gap: 8px;
        width: 100%;
      }

      .btn {
        flex: 1;
        justify-content: center;
        padding: 10px 8px;
        font-size: 0.75rem;
      }

      .project-card {
        margin: 12px;
        padding: 16px;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .progress-wrap {
        margin: 0 12px 8px;
        padding: 10px 14px;
      }

      .phases {
        padding: 0 12px 80px;
        gap: 12px;
      }

      .phase-header {
        padding: 12px 14px;
      }

      .task-row {
        padding: 10px 14px;
        grid-template-columns: 32px 1fr auto;
        gap: 10px;
      }
    }
  </style>
</head>

<body>

  <header class="app-header">
    <div>
      <h1>
        <span>Interior Design</span>
        Project Workflow
      </h1>
    </div>
    <div class="header-actions">
      <span class="save-status" id="saveStatus"></span>
      <div class="btn-group">
        <button class="btn btn-save" id="saveBtn" onclick="manualSave()">ðŸ’¾ Save</button>
        <button class="btn btn-ghost" onclick="resetAll()">â†º Reset</button>
        <button class="btn btn-ghost" onclick="logout()"
          style="border-color: rgba(255,255,255,0.2); color: #BDB5AD;">Logout</button>
      </div>
    </div>
  </header>

  <div class="project-card" id="projectCard">
    <div class="project-field">
      <label>Project Name</label>
      <input type="text" id="proj_name" placeholder="e.g. 3-Room BTO â€“ Tampines St 11" />
    </div>
    <div class="project-field">
      <label>Client Name</label>
      <input type="text" id="proj_client" placeholder="Client name" />
    </div>
    <div class="project-field">
      <label>Date of Signing</label>
      <input type="date" id="proj_date" />
    </div>
  </div>

  <div class="progress-wrap">
    <span class="progress-label">Overall Progress</span>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>
    <span class="progress-pct" id="progressPct">0%</span>
  </div>

  <div class="phases" id="phasesContainer"></div>

  <footer class="app-footer">
    <div class="footer-info">
      <strong id="footerChecked">0</strong> / <span id="footerTotal">0</span> tasks completed
    </div>
    <div class="footer-actions">
      <button class="btn btn-danger" onclick="resetAll()">Reset All</button>
    </div>
  </footer>

  <script>
    const { createClient } = supabase;
    const _supabase = createClient(
      'https://ilytehukqrkwpupdpkgo.supabase.co',
      'sb_publishable_tNMpLdZaqm0e-El_LP4kKg_fhfj-ARF'
    );

    const PHASES = [
      {
        num: 1,
        title: "Onboarding & Setup",
        sub: "Week 1",
        objective: 'Establish communication and manage "The Waiting Period."',
        tasks: [
          { action: "Create Project Group Chat", notes: "Include: ID, Project Manager, Admin (Booking), 3D Designer, & Owners." },
          { action: "Upload Project Files", notes: "Upload Original Layout, Furniture Plan, and Signed Quotation to chat." },
          { action: "Request Mood Board", notes: "Ask owner for reference photos for 3D rendering." },
          { action: "Conduct Onboarding Brief", notes: 'Explain timeline (2 weeks for 3D). Manage expectations on "waiting time."' },
          { action: "Book Material Selections", notes: "Task Admin to book: Vinyl, Tiles, Laminate, Sintered Stone, Glass." }
        ]
      },
      {
        num: 2,
        title: "Design & Owner Purchasing",
        sub: null,
        objective: "Finalize visuals and ensure owner buys critical built-in items.",
        tasks: [
          { action: "3D Rendering", notes: "Send renders to owner (approx. 2 weeks post-signing). Note: If 3D colors are totally wrong, re-render. If slight shade difference, explain to owner." },
          { action: "Owner Shopping List (Priority 1)", notes: "Ensure owner selects: Lights, Fans, Kitchen Appliances (Hob/Hood/Oven), Fridge dimensions." },
          { action: "Owner Shopping List (Priority 2)", notes: "Bathroom Accessories. (Loose furniture like sofas can wait)." }
        ]
      },
      {
        num: 3,
        title: "The First Site Visit",
        sub: "Key Collection",
        objective: "The critical technical run-through. Must be done with Aircon Contractor.",
        tasks: [
          { action: "Aircon Trunking Check", notes: "Decision: Trunking vs. L-Box? Price: Contractor to quote box-up price on the spot." },
          { action: "Carpentry Placement", notes: "Action: Tape furniture layout on floor for owner visualization." },
          { action: "Initial Site Measurement", notes: "Carpenter or ID to take fabrication measurements." },
          { action: "Electrical Walkthrough", notes: "Confirm positions for: Switches, Sockets, Data points, Ceiling lighting points." },
          { action: "Review: Shower Area", notes: "Confirm Shower Screen position & Kerb position." },
          { action: "Review: Wet Works", notes: "Cement Base: Fridge/Washing Machine base needed? Entrance: Slope or Drop? (For tiling/vinyl)." },
          { action: "Review: False Ceiling", notes: "Confirm height, curtain pelmet gap size, and cove light distance." },
          { action: "Review: Hacking", notes: "(If applicable) Mark exactly which wall and extent of hacking." }
        ]
      },
      {
        num: 4,
        title: "Documentation Protocols",
        sub: null,
        objective: "Rule: Do not rely on memory. Document immediately.",
        tasks: [
          { action: 'The "Photo Proof"', notes: "During Site Visit: Take a photo of every decision made on-site (e.g., marked socket position) and send to Group Chat immediately." },
          { action: "Same-Day Summary", notes: "Post Site Visit: Send a text summary of all discussed points and TBC items to Group Chat on the same day." }
        ]
      },
      {
        num: 5,
        title: "Commencement & Pre-Work",
        sub: null,
        objective: 'Finalize costs, collect payment, and prepare for "Dirty Work."',
        tasks: [
          { action: "Finalize Electrical Plan", notes: "Update Electrical/Lighting plan based on site visit. Zoom call to confirm." },
          { action: "Generate Electrical VO", notes: "Create Quotation/VO for Electrical work + any site visit add-ons (e.g., Aircon box-up)." },
          { action: "Billing", notes: "Issue Invoice: 35% Progress Payment + Electrical VO." },
          { action: "Collect Payment", notes: "CRITICAL: Do not start work until payment is received." },
          { action: "Start Work Schedule", notes: 'Confirm start date. Put date in "Set More" (booking system) early so Boss can arrange workers.' }
        ]
      },
      {
        num: 6,
        title: "Execution â€“ Wet Works & Ceiling",
        sub: null,
        objective: "Structural works and forward planning.",
        tasks: [
          { action: "Day 1: Hacking & Electrical Briefing", notes: "ID must go down. Brief workers on what to hack. Confirm positions with Owner." },
          { action: "Site Protection", notes: "Priority 1: Instruct workers to protect house/flooring before any work starts." },
          { action: "Forward Planning (Critical)", notes: "Do not wait for electrical to finish to plan next step.\n1. Book False Ceiling Guy.\n2. Book Tiler (Note: Tiler does not haul tiles; book in-house labor for haulage).\n3. Order and Deliver Tiles." },
          { action: "Electrical Inspection", notes: "Confirm all wiring/points correct before False Ceiling guy comes in." },
          { action: "False Ceiling Inspection", notes: "ID must check false ceiling work (leveling/structure) before Tiler comes in." }
        ]
      },
      {
        num: 7,
        title: 'Carpentry Prep',
        sub: 'The "Fabrication Gap" â€“ approx. 2â€“3 weeks',
        objective: "Detailed planning while carpentry is being made.",
        tasks: [
          { action: "Re-Measure Site", notes: "Once tiling/ceiling is done, heights change. Do site measurement again for accuracy." },
          { action: "Carpentry Drawings", notes: "Send measurements to drafter (Nancy). Produce drawings (3â€“5 days). Send to Owner." },
          { action: "On-Site Carpentry Discussion", notes: "Meet owner on-site.\nMust Confirm:\n1. Depth of carpentry.\n2. Exact switch/socket positions inside carpentry (Left/Right/Top/Bottom)." },
          { action: "Laminate Confirmation", notes: "Confirm Laminate codes using 3D renders as a guide." },
          { action: "Fabrication Handover", notes: "Pass confirmed drawings to Carpenter (Daniel/Boss/Self) to start fabrication." },
          { action: "Mid-Reno Coordination", notes: "While waiting for carpentry (2â€“3 weeks):\n1. Suppliers measure Windows/Shower Screens.\n2. Painter: Sealer & Matex (1st Coat).\n3. Plumber: Run pipings, install storage heater.\n4. Electrician." },
          { action: "Owner Delivery Reminder", notes: "Remind owner to deliver Hob/Hood/Oven/Sinks now so they are ready for carpentry installation." }
        ]
      },
      {
        num: 8,
        title: "Carpentry Installation",
        sub: null,
        objective: "Installation and supervision.",
        tasks: [
          { action: "Installation Day 1", notes: 'ID must be present. Act as "Kepala" (Supervisor) to direct placement and workflow.' },
          { action: "Routine Checks", notes: "Visit site every 2â€“3 days during installation to catch issues early." },
          { action: "Electrical 2nd Fix", notes: "Once carpentry is up, Electrician returns to install switches/sockets onto the carpentry." }
        ]
      },
      {
        num: 9,
        title: "Countertops & Finishing",
        sub: null,
        objective: "The final push.",
        tasks: [
          { action: "Table Top Measurement", notes: "Arrange stone supplier to measure. Confirm Stone color with owner." },
          { action: "Touch-Up & Painting", notes: "While waiting for stone:\n1. Touch-up Man (Joint lines/carpentry).\n2. Painter (Final Coat)." },
          { action: "Plumbing Finals", notes: "After stone installed: Plumber installs Sink, Tap, Bathroom Accessories, Dishwasher/Washing machine." }
        ]
      },
      {
        num: 10,
        title: "Handover",
        sub: null,
        objective: "Client Inspection and completion.",
        tasks: [
          { action: "Owner Walkthrough", notes: "Invite owner to site. Walk around to identify any final touch-ups needed." },
          { action: "Final Rectification", notes: "Execute touch-ups based on walkthrough." },
          { action: "General Cleaning", notes: "Perform one last round of general cleaning." },
          { action: "Handover", notes: "Official handover of keys and project completion." }
        ]
      }
    ];

    // State
    let state = {};
    let projectId = new URLSearchParams(window.location.search).get('project_id');
    let isReadonly = new URLSearchParams(window.location.search).get('readonly') === 'true';
    let currentUser = null;
    let currentUserIsAdmin = false;

    function getKey(pIdx, tIdx) { return `p${pIdx}_t${tIdx}`; }
    function getNoteKey(pIdx) { return `note_p${pIdx}`; }

    async function logout() {
      await _supabase.auth.signOut();
      window.location.href = 'index.html';
    }

    async function init() {
      const { data: { session } } = await _supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
        return;
      }
      currentUser = session.user;
      document.body.style.display = 'block';
      if (isReadonly) document.body.classList.add('readonly');

      if (projectId) {
        await loadProjectData();
      } else {
        alert('No project ID found');
        window.location.href = 'index.html';
      }
    }

    async function loadProjectData() {
      const { data: project, error } = await _supabase
        .from('projects')
        .select('*')
        .eq('id', projectId)
        .single();

      if (!project || error) {
        alert('Project not found.');
        window.location.href = 'index.html';
        return;
      }

      // Ownership check: fetch current user's profile to check role/name
      const { data: profile } = await _supabase
        .from('profiles')
        .select('role, full_name')
        .eq('id', currentUser.id)
        .single();

      const isAdmin = profile && profile.role === 'admin';
      currentUserIsAdmin = isAdmin;
      const isOwner = project.user_id === currentUser.id;

      if (!isOwner && !isAdmin) {
        alert('You do not have permission to view this project');
        window.location.href = 'index.html';
        return;
      }

      state = project.phase_data || {};
      document.getElementById('proj_name').value = project.project_name || '';
      document.getElementById('proj_client').value = project.client_name || '';
      document.getElementById('proj_date').value = project.date_of_signing || '';
      buildUI();
    }

    function triggerSave() {
      if (isReadonly) return;
      const statusEl = document.getElementById('saveStatus');
      statusEl.textContent = 'Unsaved changesâ€¦';
      statusEl.style.color = '#BDB5AD';
    }

    async function manualSave() {
      if (isReadonly) return;
      await saveProjectData();
    }

    async function saveProjectData() {
      const pName = document.getElementById('proj_name').value;
      const cName = document.getElementById('proj_client').value;
      const dSign = document.getElementById('proj_date').value;

      // Check if completed
      let totalTasks = PHASES.reduce((acc, p) => acc + p.tasks.length, 0);
      let checkedTasks = 0;
      PHASES.forEach((p, pIdx) => {
        p.tasks.forEach((_, tIdx) => {
          if (state[getKey(pIdx, tIdx)]) checkedTasks++;
        });
      });
      const status = checkedTasks === totalTasks ? 'completed' : 'in_progress';

      let query = _supabase
        .from('projects')
        .update({
          project_name: pName,
          client_name: cName,
          date_of_signing: dSign,
          phase_data: state,
          status: status,
          updated_at: new Date().toISOString()
        })
        .eq('id', projectId);

      // For non-admin users, add user_id filter to satisfy RLS policy
      if (!currentUserIsAdmin) {
        query = query.eq('user_id', currentUser.id);
      }

      const { error } = await query;

      const statusEl = document.getElementById('saveStatus');
      if (error) {
        console.error('Save error:', error.message, error.details, error.hint);
        statusEl.textContent = 'Save failed âœ—';
        statusEl.style.color = '#B85C5C';
      } else {
        statusEl.textContent = 'Saved âœ“';
        statusEl.style.color = '#C4956A';
      }
    }

    function updateProgress() {
      let total = 0, done = 0;
      PHASES.forEach((phase, pIdx) => {
        phase.tasks.forEach((_, tIdx) => {
          total++;
          if (state[getKey(pIdx, tIdx)]) done++;
        });
      });

      const pct = total > 0 ? Math.round((done / total) * 100) : 0;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressPct').textContent = pct + '%';
      document.getElementById('footerChecked').textContent = done;
      document.getElementById('footerTotal').textContent = total;

      PHASES.forEach((phase, pIdx) => {
        const el = document.getElementById(`phase_${pIdx}`);
        if (!el) return;
        const allDone = phase.tasks.every((_, tIdx) => state[getKey(pIdx, tIdx)]);
        el.classList.toggle('completed', allDone);
        const cnt = phase.tasks.filter((_, tIdx) => state[getKey(pIdx, tIdx)]).length;
        const countEl = el.querySelector('.phase-count');
        if (countEl) countEl.textContent = `${cnt} / ${phase.tasks.length}`;
      });
    }

    function formatTimestamp() {
      const now = new Date();
      const date = now.toLocaleDateString('en-SG', { day: '2-digit', month: 'short', year: 'numeric' });
      const time = now.toLocaleTimeString('en-SG', { hour: '2-digit', minute: '2-digit', hour12: true });
      return date + ' / ' + time;
    }

    function toggleTask(pIdx, tIdx) {
      if (isReadonly) return;
      const key = getKey(pIdx, tIdx);
      state[key] = !state[key];

      // Auto-populate or clear timestamp
      const signKey = `sign_p${pIdx}_t${tIdx}`;
      if (state[key]) {
        state[signKey] = formatTimestamp();
      } else {
        delete state[signKey];
      }

      const row = document.getElementById(`row_${pIdx}_${tIdx}`);
      row.classList.toggle('checked', state[key]);

      // Update the timestamp display in the row
      const tsEl = row.querySelector('.task-timestamp');
      if (tsEl) {
        if (state[signKey]) {
          tsEl.innerHTML = '<span class="timestamp-value">' + state[signKey].replace('\n', '<br>') + '</span>';
        } else {
          tsEl.innerHTML = '<span class="timestamp-empty">â€”</span>';
        }
      }

      updateProgress();
      triggerSave();
    }

    function togglePhase(pIdx) {
      const el = document.getElementById(`phase_${pIdx}`);
      el.classList.toggle('open');
    }

    function saveNote(pIdx, val) {
      state[getNoteKey(pIdx)] = val;
      triggerSave();
    }

    function buildUI() {
      const container = document.getElementById('phasesContainer');
      container.innerHTML = '';

      PHASES.forEach((phase, pIdx) => {
        const el = document.createElement('div');
        el.className = 'phase';
        el.id = `phase_${pIdx}`;

        // Auto-open first incomplete phase or if all complete open first
        const allDone = phase.tasks.every((_, tIdx) => state[getKey(pIdx, tIdx)]);
        if (!allDone && pIdx === 0) el.classList.add('open');

        const cnt = phase.tasks.filter((_, tIdx) => state[getKey(pIdx, tIdx)]).length;

        el.innerHTML = `
      <div class="phase-header" onclick="togglePhase(${pIdx})">
        <div class="phase-number">${phase.num}</div>
        <div class="phase-title-wrap">
          <div class="phase-title">${phase.title}${phase.sub ? ` <small style="font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:400;color:var(--warm-mid);">&mdash; ${phase.sub}</small>` : ''}</div>
          <div class="phase-objective">${phase.objective}</div>
        </div>
        <div class="phase-meta">
          <span class="phase-count">${cnt} / ${phase.tasks.length}</span>
          <span class="chevron">â–¼</span>
        </div>
      </div>
      <div class="phase-body" id="phasebody_${pIdx}">
        ${phase.tasks.map((task, tIdx) => {
          const checked = state[getKey(pIdx, tIdx)] ? 'checked' : '';
          const tsVal = state[`sign_p${pIdx}_t${tIdx}`] || '';
          return `
          <div class="task-row ${checked}" id="row_${pIdx}_${tIdx}">
            <div class="task-checkbox-wrap">
              <div class="task-checkbox" onclick="toggleTask(${pIdx}, ${tIdx})"></div>
            </div>
            <div class="task-content">
              <div class="task-action">${task.action}</div>
              <div class="task-notes">${task.notes.replace(/\n/g, '<br>')}</div>
            </div>
            <div class="task-timestamp" onclick="event.stopPropagation()">
              ${tsVal
              ? `<span class="timestamp-value">${tsVal.replace(/\n/g, '<br>')}</span>`
              : `<span class="timestamp-empty">â€”</span>`}
            </div>
          </div>`;
        }).join('')}
        <div class="phase-notes-area">
          <label>Phase Notes</label>
          <textarea placeholder="Add site notes, decisions, or follow-ups for this phaseâ€¦" 
            onclick="event.stopPropagation()"
            oninput="saveNote(${pIdx}, this.value)">${state[getNoteKey(pIdx)] || ''}</textarea>
        </div>
      </div>
    `;

        if (allDone) el.classList.add('completed');
        container.appendChild(el);
      });

      updateProgress();
    }


    function resetAll() {
      if (isReadonly) return;
      if (!confirm('Reset all checkboxes and notes? Project name and client info will be kept.')) return;
      state = {};
      buildUI();
      triggerSave();
    }

    // Event Listeners
    document.getElementById('proj_name').addEventListener('input', triggerSave);
    document.getElementById('proj_client').addEventListener('input', triggerSave);
    document.getElementById('proj_date').addEventListener('change', triggerSave);

    init();
  </script>
</body>

</html>